<style>
  /* 移动端隐藏分类导航 */
  @media (max-width: 767px) {
    #pc-category-nav {
      display: none !important;
    }
    /* Safari专属：修复菜单定位和点击区域 */
    .mobile-menu-btn {
      -webkit-tap-highlight-color: transparent; /* 移除Safari点击高亮 */
    }
    .mobile-dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 8px; /* 避免紧贴按钮 */
      z-index: 50; /* 确保层级最高，不被遮挡 */
    }
  }
</style>

{{/* 三栏布局：左Logo + 中分类 + 右原有菜单 */}}
{{ if site.Params.enableCategoryNav | default false }}
  {{/* 统一添加Alpine.js状态（粘性/非粘性导航共用） */}}
  <nav x-data="{
    isSticky: false,
    dropdownOpen: false // 控制移动端菜单的唯一状态
  }"
    x-init="
      // 滚动监听（原生轻量，无防抖不影响性能）
      window.addEventListener('scroll', () => {
        isSticky = window.scrollY > 30;
      });
      // Safari专属：ESC键关闭菜单
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') dropdownOpen = false;
      });
    "
    class="sticky top-0 z-30 mt-4 lg:mt-8 py-4"
    :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }">
    {{ if site.Params.zenMode }}
    <div class="container max-w-[65ch] mx-auto px-4 md:px-0">
    {{ else }}
    <div class="container px-4">
    {{ end }}
      <div class="flex items-center justify-between w-full">
        {{/* 左侧：Logo区域（保持不变） */}}
        <section class="flex items-center gap-4">
          <div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="{{ T "flip" }}">
            <div class="h-10 rounded-full">
              <img src="{{ site.Params.avatar | relURL }}" alt="{{ site.Params.headerTitle }}" />
            </div>
          </div>
          {{ if or site.Params.headerTitle site.Params.motto }}
          <div>
            {{ if site.Params.headerTitle }}
            <a href="/" class="text-lg font-semibold cursor-pointer">
              {{ site.Params.headerTitle }}
            </a>
            {{ end }}
            {{ if site.Params.motto }}
            <div class="text-base-content/60 text-sm">{{ site.Params.motto }}</div>
            {{ end }}
          </div>
          {{ end }}
        </section>

        {{/* 中间：分类导航（保持稳定版） */}}
        <div id="pc-category-nav" class="flex items-center justify-center flex-1 px-4">
          {{ partial "nav-category-extension.html" . }}
        </div>

        {{/* 右侧：菜单区域（Safari兼容修复） */}}
        <div class="flex items-center relative">
          <!-- 移动端菜单：纯Alpine.js控制，无Tailwind dropdown依赖 -->
          <div class="sm:hidden">
            <!-- 菜单按钮：移除tabindex，添加Safari专属样式 -->
            <button
              class="btn btn-ghost btn-square mobile-menu-btn"
              aria-label="菜单"
              @click="dropdownOpen = !dropdownOpen"
              :aria-expanded="dropdownOpen">
              <ion-icon name="menu" class="text-2xl"></ion-icon>
            </button>

            <!-- 下拉菜单：绝对定位，避免Safari布局错乱 -->
            <ul
              class="mobile-dropdown-menu menu w-36 bg-base-100 rounded-box shadow-md overflow-hidden"
              x-show="dropdownOpen"
              @click.away="dropdownOpen = false"
              aria-hidden="!dropdownOpen">
              {{ $navItems := slice "about" "search" "rss" "posts" "categories" "tags" }}
              {{ if site.Params.reorderNavItems }}
                {{ $navItems = site.Params.reorderNavItems }}
              {{ end }}
              {{ partial "navMobileMenu.html" (dict "navItems" $navItems) }}
            </ul>
          </div>

          <!-- 桌面端菜单（保持不变） -->
          <section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4">
            {{ $navItems := slice "about" "search" "rss" "posts" "categories" "tags" }}
            {{ if site.Params.reorderNavItems }}
              {{ $navItems = site.Params.reorderNavItems }}
            {{ end }}
            {{ if not site.Params.collapseNavItems }}
              {{ range $navItems }}
              {{ partial "renderNavItem.html" . }}
              {{ end }}
              {{ with site.Params.navItems }}
              {{ partial "navCustomItems.html" (dict "navItems" $navItems "mobile" false) }}
              {{ end }}
            {{ else }}
              {{ $collapseNavItems := site.Params.collapseNavItems }}
              {{ $items := complement $collapseNavItems $navItems }}
              {{ range $items }}
              {{ partial "renderNavItem.html" . }}
              {{ end }}
              <div class="dropdown dropdown-end dropdown-hover">
                <div tabindex="0" role="button" class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option">
                  <ion-icon class="group-hover:text-primary-content text-xl" name="menu"></ion-icon>
                </div>
                <ul tabindex="0" class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl">
                  {{ range $collapseNavItems }}
                  {{ partial "renderMobileNavItem.html" . }}
                  {{ end }}
                  {{ with site.Params.navItems }}
                  {{ partial "navCustomItems.html" (dict "navItems" $navItems "mobile" true) }}
                  {{ end }}
                </ul>
              </div>
            {{ end }}
          </section>
        </div>
      </div>
    </div>
  </nav>
{{ else }}
  {{/* 未启用时直接显示原有导航（移除多余的nav标签，修复语法错误） */}}
  {{ partial "original-nav.html" . }}
{{ end }}