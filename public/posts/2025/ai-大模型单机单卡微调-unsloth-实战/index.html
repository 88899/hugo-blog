<!DOCTYPE html>
<html lang="zh-Hans"
  x-data
  :class="$store.darkMode.class()"
  :data-theme="$store.darkMode.theme()">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 大模型单机单卡微调-Unsloth 实战 | 编程技术｜运维技术｜建站技巧｜后端开发｜前端开发｜知识库｜免费资源</title>

    
  
    <link href="/img/personal/avatar.png" rel="icon" type="image/x-icon" />
  


<link rel="canonical" href="https://googhub.nyc.mn/posts/2025/ai-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8D%95%E6%9C%BA%E5%8D%95%E5%8D%A1%E5%BE%AE%E8%B0%83-unsloth-%E5%AE%9E%E6%88%98/" />



<meta name="author" content="Sherry" />
<meta name="description" content="聚焦单机单卡（如 RTX 3090/4090）AI 大模型微调场景，以 Unsloth 工具为核心，涵盖微调技术与工具横向对比、双系统（Ubuntu/Windows）环境搭建、数据集处理、模型配置与预加载、训练执行与监控、模型部署测试及常见问题排查全流程，提供可直接参照的命令与代码示例，助力技术人员实现轻量化高效微调，同时给出适配不同显存的选型建议，平衡显存占用、训练速度与微调效果" />


<meta name="keywords" content="技术,经验">



<meta name="generator" content="Hugo 0.148.2">


<meta property="og:url" content="https://googhub.nyc.mn/posts/2025/ai-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8D%95%E6%9C%BA%E5%8D%95%E5%8D%A1%E5%BE%AE%E8%B0%83-unsloth-%E5%AE%9E%E6%88%98/">
  <meta property="og:site_name" content="编程技术｜运维技术｜建站技巧｜后端开发｜前端开发｜知识库｜免费资源">
  <meta property="og:title" content="AI 大模型单机单卡微调-Unsloth 实战">
  <meta property="og:description" content="聚焦单机单卡（如 RTX 3090/4090）AI 大模型微调场景，以 Unsloth 工具为核心，涵盖微调技术与工具横向对比、双系统（Ubuntu/Windows）环境搭建、数据集处理、模型配置与预加载、训练执行与监控、模型部署测试及常见问题排查全流程，提供可直接参照的命令与代码示例，助力技术人员实现轻量化高效微调，同时给出适配不同显存的选型建议，平衡显存占用、训练速度与微调效果">
  <meta property="og:locale" content="zh_Hans">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-06T00:00:00+00:00">
    <meta property="article:tag" content="技术">
    <meta property="article:tag" content="经验">
    <meta property="og:image" content="https://googhub.nyc.mn/img/global-background.jpg">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2025/ai-%E7%A0%94%E5%8F%91%E5%85%A8%E6%A0%88%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2025/langgraph-%E5%AE%9E%E6%88%983-%E6%AD%A5%E6%90%AD%E5%BB%BA-agent-%E5%BD%BB%E5%BA%95%E5%91%8A%E5%88%AB%E6%89%8B%E6%90%93%E7%97%9B%E8%8B%A6/">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2024/%E6%80%8E%E4%B9%88%E8%AE%A9hugo%E6%94%AF%E6%8C%81markdown-%E6%B5%81%E7%A8%8B%E5%9B%BE/">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2024/docker-%E4%B8%8E-podman-%E6%B7%B1%E5%BA%A6%E5%AF%B9%E6%AF%94%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B7%A5%E5%85%B7%E7%9A%84%E5%85%A8%E6%96%B9%E4%BD%8D%E8%A7%A3%E6%9E%90/">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2024/%E6%88%91%E8%AE%A9%E6%89%A3%E5%AD%90%E7%A9%BA%E9%97%B4%E5%B8%AE%E6%88%91%E9%A2%84%E6%B5%8B%E6%B2%AA%E6%B7%B1300%E7%9A%84%E6%98%8E%E6%97%A5%E8%B4%AD%E4%B9%B0%E7%AD%96%E7%95%A5/">
      <meta property="og:see_also" content="https://googhub.nyc.mn/posts/2024/%E4%BB%8Eapi-key%E5%88%B0%E6%99%BA%E8%83%BD%E5%AF%B9%E8%AF%9D%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E6%B5%81%E5%BC%8F%E8%81%8A%E5%A4%A9%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://googhub.nyc.mn/img/global-background.jpg">
  <meta name="twitter:title" content="AI 大模型单机单卡微调-Unsloth 实战">
  <meta name="twitter:description" content="聚焦单机单卡（如 RTX 3090/4090）AI 大模型微调场景，以 Unsloth 工具为核心，涵盖微调技术与工具横向对比、双系统（Ubuntu/Windows）环境搭建、数据集处理、模型配置与预加载、训练执行与监控、模型部署测试及常见问题排查全流程，提供可直接参照的命令与代码示例，助力技术人员实现轻量化高效微调，同时给出适配不同显存的选型建议，平衡显存占用、训练速度与微调效果">
      <meta name="twitter:site" content="@dgdghub">




  

<link rel="stylesheet" href="/css/output.min.css" />




    
    <style>
         
        #loading {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .loader {
            width: 250px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: helvetica, arial, sans-serif;
            text-transform: uppercase;
            font-weight: 900;
            color: #00a96e;
            letter-spacing: 0.2em;
            user-select: none;
        }

        .loader::before,
        .loader::after {
            content: "";
            display: block;
            width: 15px;
            height: 15px;
            background: #00a96e;
            position: absolute;
            animation: load .7s infinite alternate ease-in-out;
            will-change: left, height, width;
        }

        .loader::before {
            top: 0
        }

        .loader::after {
            bottom: 0
        }

        @keyframes load {
            0% {
                left: 0;
                height: 30px;
                width: 15px
            }

            50% {
                height: 8px;
                width: 40px
            }

            100% {
                left: 235px;
                height: 30px;
                width: 15px
            }
        }

         
        #loading, #load-loading, .load-loading {
            justify-content: center;
            align-items: center;
            display: -webkit-box;
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999999;
            background: #fff;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            pointer-events: auto;
        }

        .load-loading {
            position: absolute;
            background: transparent
        }

        .load-loading .bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0.2
        }

        #load-loading {
            opacity: 0
        }

        #loading.close {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none;
        }

        .io-black-mode #loading,
        .io-black-mode #load-loading {
            background: #111;
        }

        @media (prefers-reduced-motion: reduce) {
            .loader::before,
            .loader::after {
                animation: none;
            }

            #loading, #load-loading, .load-loading {
                transition: none;
            }
        }
    </style>

    
    <div id="loading" role="progressbar" aria-label="页面加载中">
        <div class="loader">AiEDU</div>
    </div>

    <script>
        
        (function() {
            const loadingScreen = document.getElementById('loading');
            if (!loadingScreen) return;

            function hideLoadingScreen() {
                if (!loadingScreen.classList.contains('close')) {
                    loadingScreen.classList.add('close');

                    
                    setTimeout(() => {
                        if (loadingScreen.parentNode) {
                            loadingScreen.parentNode.removeChild(loadingScreen);
                        }
                    }, 500);
                }
            }

            
            window.addEventListener('load', function() {
                const delay = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 300;
                setTimeout(hideLoadingScreen, delay);
            });

            
            window.addEventListener('beforeunload', function() {
                loadingScreen.classList.remove('close');
            });

            
            if (window.pjax) {
                document.addEventListener('pjax:send', function() {
                    loadingScreen.classList.remove('close');
                });

                document.addEventListener('pjax:complete', function() {
                    const delay = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 300;
                    setTimeout(hideLoadingScreen, delay);
                });
            }

            
            setTimeout(hideLoadingScreen, 8000);
        })();
    </script>





    


<link rel="stylesheet" data-custom-syntax-highlighting />
<style>
  .chroma {
    padding: 1em;
    background-color: var(--dream-pre-bg, #f5f5f5);
    border-radius: .5em;
    overflow: auto;
  }

  html.dark .chroma {
    background-color: var(--dream-pre-bg-dark, #262626);
  }
</style>









    
    <link rel="stylesheet" href="/css/custom.css" />
    

    
    <script defer src="/js/cdn.min.js"></script>
  </head>

  <body x-data="{
    flip: false,
  }" oncopy="return false" oncut="return false" onpaste="return false">
    
    <div id="dream-global-bg"></div>

    

  
  <nav x-data="{ isSticky: false }"
    x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })"
    class="sticky top-0 z-30 mt-4 lg:mt-8 py-4"
    :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }">
  
    
    <div class="container px-4">
    
      <div class="flex items-center justify-between w-full">
        
        <section class="flex items-center gap-4">
          <div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="翻转一下！">
            <div class="h-10 rounded-full">
              <img src="/img/personal/avatar.png" alt="AiEDU | BLOG" />
            </div>
          </div>
          
          <div>
            
            <a href="/" class="text-lg font-semibold cursor-pointer">
              AiEDU | BLOG
            </a>
            
            
            <div class="text-base-content/60 text-sm">AI 赋能，智启教育</div>
            
          </div>
          
        </section>

        
        

<style>
   
  .category-nav-container {
    @apply hidden md:flex items-end justify-center gap-2 px-4 !important;
    height: 100%;
  }
</style>


<div class="category-nav-container">
  
  <a
    href="/categories/%E7%BC%96%E7%A8%8B/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="编程"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    编程
  </a>
  
  <a
    href="/categories/vps/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="vps"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    VPS
  </a>
  
  <a
    href="/categories/ai/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="ai"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    AI
  </a>
  
  <a
    href="/categories/devops/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="devops"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    DEVOPS
  </a>
  
  <a
    href="/categories/%E7%9F%A5%E8%AF%86%E5%BA%93/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="知识库"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    知识库
  </a>
  
  <a
    href="/categories/it/"
    class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
    title="it"
    style="
      font-size: 1rem !important;
      margin: 0 0.5rem !important; /* 左右间距0.5rem，上下0 */
      border-radius: 9999px !important; /* 强制圆形 */
    "
  >
    IT
  </a>
  
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const mobileMenu = document.querySelector('.dropdown-content.menu');
  if (mobileMenu) {
    const divider = document.createElement('li');
    divider.innerHTML = '<hr class="my-1 border-base-content/20">';
    mobileMenu.appendChild(divider);

    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/%E7%BC%96%E7%A8%8B\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        编程
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/vps\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        VPS
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/ai\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        AI
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/devops\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        DEVOPS
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/%E7%9F%A5%E8%AF%86%E5%BA%93\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        知识库
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
    const categoryItem2 = document.createElement('li');
    categoryItem2.innerHTML = `
      <a
        href="\/categories\/it\/"
        class="badge h-6 no-underline text-gray-800 bg-green-100 hover:badge-primary hover:text-white rounded-full py-1.5 px-3.5 mx-2 transition-all duration-200 ease-in-out text-uppercase !important"
        style="
          font-size: 1rem !important;
          border-radius: 9999px !important;
        "
      >
        IT
      </a>
    `;
    mobileMenu.appendChild(categoryItem2);
    
  }
});
</script>


        
        <div class="flex items-center">
          <div class="dropdown dropdown-end sm:hidden">
            <div tabindex="0" role="button" class="btn btn-ghost btn-square" aria-label="Select an option">
              <ion-icon name="menu" class="text-2xl"></ion-icon>
            </div>
            <ul tabindex="0" class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md">
              
              
                
              
              






<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/" target="" title="首页">
    
    <ion-icon name="home"></ion-icon>
    
    首页
  </a>
</li>





<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/categories" title="所有分类">
    <ion-icon name="grid"></ion-icon>
    所有分类
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/tags" title="所有标签">
    <ion-icon name="pricetags"></ion-icon>
    所有标签
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/posts" title="归档">
    <ion-icon name="archive"></ion-icon>
    归档
  </a>
</li>







<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="https://www.518855.xyz" target="" title="导航">
    
    <ion-icon name="rocket"></ion-icon>
    
    导航
  </a>
</li>








<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="https://cici.pp.ua" target="" title="文档">
    
    <ion-icon name="documents"></ion-icon>
    
    文档
  </a>
</li>





<li>
  <a class="group inline-flex items-center p-2 cursor-pointer" href="/search" title="搜索">
    <ion-icon name="search"></ion-icon>
    搜索
  </a>
</li>







<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="https://github.com/88899" target="" title="GitHub">
    
    <ion-icon name="logo-github"></ion-icon>
    
    GitHub
  </a>
</li>









<li>
  <div role="link" tabindex="0" class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title="关于">
    <ion-icon name="information-circle"></ion-icon>关于</div>
</li>



























            </ul>
          </div>
          <section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4">
            
            
              
            
            
              
              



  
  <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/" target="" title="首页">
    <ion-icon class="group-hover:text-primary-content" name="home"></ion-icon>
  </a>
  



              
              
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/categories" title="所有分类">
  <ion-icon class="group-hover:text-primary-content" name="grid"></ion-icon>
</a>


              
              
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/tags" title="所有标签">
  <ion-icon class="group-hover:text-primary-content" name="pricetags"></ion-icon>
</a>


              
              
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/posts" title="归档">
  <ion-icon class="group-hover:text-primary-content" name="archive"></ion-icon>
</a>


              
              



  
  <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://www.518855.xyz" target="" title="导航">
    <ion-icon class="group-hover:text-primary-content" name="rocket"></ion-icon>
  </a>
  



              
              



  
  <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://cici.pp.ua" target="" title="文档">
    <ion-icon class="group-hover:text-primary-content" name="documents"></ion-icon>
  </a>
  



              
              
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/search" title="搜索">
  <ion-icon class="group-hover:text-primary-content" name="search"></ion-icon>
</a>


              
              



  
  <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://github.com/88899" target="" title="GitHub">
    <ion-icon class="group-hover:text-primary-content" name="logo-github"></ion-icon>
  </a>
  



              
              




<div role="link" tabindex="0" class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title="关于">关于</div>





              
              
              
















              
            
          </section>
        </div>
      </div>
    </div>
  </nav>


    <div class="flip-container" :class="{ 'flip-it': flip }">
      <div class="flipper">
        <div class="front">
          <div class="container">
            
<div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4">


  <div class="lg:col-span-2">
    <article class="mx-auto prose prose-quoteless dark:prose-invert" id="dream-single-post-main" itemscope itemtype="http://schema.org/Article">
      
  <meta itemprop="name" content="AI 大模型单机单卡微调-Unsloth 实战">
  <meta itemprop="description" content="聚焦单机单卡（如 RTX 3090/4090）AI 大模型微调场景，以 Unsloth 工具为核心，涵盖微调技术与工具横向对比、双系统（Ubuntu/Windows）环境搭建、数据集处理、模型配置与预加载、训练执行与监控、模型部署测试及常见问题排查全流程，提供可直接参照的命令与代码示例，助力技术人员实现轻量化高效微调，同时给出适配不同显存的选型建议，平衡显存占用、训练速度与微调效果">
  <meta itemprop="datePublished" content="2025-11-05T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-11-06T00:00:00+00:00">
  <meta itemprop="wordCount" content="7689">
  <meta itemprop="image" content="https://googhub.nyc.mn/img/global-background.jpg">
  <meta itemprop="keywords" content="技术,经验">

      <header>
        <h1 itemprop="headline">AI 大模型单机单卡微调-Unsloth 实战</h1>
        <p class="text-sm">
          
            <span data-format="luxon">2025-11-05T00:00:00Z</span>
          

          | <span>16分钟阅读</span>

          
          | <span>更新于
            
              <span data-format="luxon">2025-11-06T00:00:00Z</span>
            </span>
          
        </p>

        
        <div class="flex justify-between">
          
            <div class="flex items-center">
  
  <div class="avatar mr-1">
    <div class="w-8 rounded-full">
      <img class="my-0!" src="https://s3.aiedu.qzz.io/website/2025/10/c9636914b0782ae3f9269b50dcb88659.png" alt="Sherry" />
    </div>
  </div>
  

  <span itemprop="author" itemscope itemtype="https://schema.org/Person">
  
    
      <span itemprop="name">Sherry</span>
    
  
  </span>
</div>

          

          <div class="flex items-center gap-2">
  
  

  
  
  
  
    
  
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="" target="_blank" rel="noopener noreferrer"
      title="Share on WeChat">
      <ion-icon class="group-hover:text-primary-content" name="logo-WeChat"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://x.com/intent/post?text=AI%20%e5%a4%a7%e6%a8%a1%e5%9e%8b%e5%8d%95%e6%9c%ba%e5%8d%95%e5%8d%a1%e5%be%ae%e8%b0%83-Unsloth%20%e5%ae%9e%e6%88%98&amp;url=https://googhub.nyc.mn/posts/2025/ai-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8D%95%E6%9C%BA%E5%8D%95%E5%8D%A1%E5%BE%AE%E8%B0%83-unsloth-%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener noreferrer"
      title="Share on X">
      <ion-icon class="group-hover:text-primary-content" name="logo-x"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://facebook.com/sharer/sharer.php?u=https://googhub.nyc.mn/posts/2025/ai-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8D%95%E6%9C%BA%E5%8D%95%E5%8D%A1%E5%BE%AE%E8%B0%83-unsloth-%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener noreferrer"
      title="Share on Facebook">
      <ion-icon class="group-hover:text-primary-content" name="logo-facebook"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://wa.me/?text=AI%20%e5%a4%a7%e6%a8%a1%e5%9e%8b%e5%8d%95%e6%9c%ba%e5%8d%95%e5%8d%a1%e5%be%ae%e8%b0%83-Unsloth%20%e5%ae%9e%e6%88%98%20https://googhub.nyc.mn/posts/2025/ai-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8D%95%E6%9C%BA%E5%8D%95%E5%8D%A1%E5%BE%AE%E8%B0%83-unsloth-%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener noreferrer"
      title="Share on WhatsApp">
      <ion-icon class="group-hover:text-primary-content" name="logo-whatsapp"></ion-icon>
    </a>
  

  
  
</div>

        </div>
      </header>

      <section id="dream-single-post-content" itemprop="articleBody">
        
          <img class="w-full z-30" src="https://s3.aiedu.qzz.io/website/2025/11/95e07365779a7604d919d4383b83ac0b.png" alt="AI 大模型单机单卡微调-Unsloth 实战" />
        

        <p>本文聚焦单机单卡硬件场景，围绕 Unsloth 工具展开 AI 大模型微调技术实践，覆盖从环境搭建、数据处理、模型配置、训练执行到部署测试的全流程。手册内容以实操为核心，包含详细命令、代码示例及问题排查方案，适用于需要在消费级 GPU（如 RTX 3090/4090）上实现轻量化微调的技术人员，同时提供主流微调技术与工具的横向对比，为技术选型提供参考。</p>
<h2 id="一微调核心技术与工具横向对比">一、微调核心技术与工具横向对比</h2>
<h3 id="11-核心微调技术对比">1.1 核心微调技术对比</h3>
<table>
  <thead>
      <tr>
          <th>技术类型</th>
          <th>显存占用</th>
          <th>训练速度</th>
          <th>微调效果</th>
          <th>硬件门槛</th>
          <th>适用场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>全参数微调</td>
          <td>极高</td>
          <td>慢</td>
          <td>最佳</td>
          <td>80GB+</td>
          <td>企业级高精度需求</td>
      </tr>
      <tr>
          <td>LoRA（低秩适配）</td>
          <td>中</td>
          <td>中</td>
          <td>优良</td>
          <td>24GB+</td>
          <td>通用场景任务定制</td>
      </tr>
      <tr>
          <td>QLoRA（量化 LoRA）</td>
          <td>低</td>
          <td>中</td>
          <td>良好</td>
          <td>16GB+</td>
          <td>消费级 GPU 轻量化微调</td>
      </tr>
      <tr>
          <td>Unsloth 全参数微调</td>
          <td>中低</td>
          <td>极快</td>
          <td>最佳</td>
          <td>24GB+</td>
          <td>单机单卡高精度需求</td>
      </tr>
      <tr>
          <td>Adapter 微调</td>
          <td>低</td>
          <td>快</td>
          <td>一般</td>
          <td>12GB+</td>
          <td>简单任务快速适配</td>
      </tr>
  </tbody>
</table>
<h4 id="关键技术解析">关键技术解析</h4>
<ul>
<li>
<p><strong>Unsloth 优化机制</strong>：通过动态量化、稀疏优化、梯度检查点改进、激活值卸载四大技术，将全参数微调显存占用降低 75%，训练速度提升 30 倍，无需插入 Adapter 层即可直接训练全部参数。</p>
</li>
<li>
<p><strong>QLoRA 局限性</strong>：4-bit 量化可能导致精度损失，复杂任务（如医疗问答、企业知识库）表现弱于 Unsloth 全参数微调。</p>
</li>
<li>
<p><strong>Unsloth 全参数微调优势</strong>：通过优化器状态分页（Paged Optimizer）将优化器状态分页至 CPU，24GB 显存可支持 7B 模型全参数微调。</p>
</li>
</ul>
<h3 id="12-主流微调工具性能评测">1.2 主流微调工具性能评测</h3>
<table>
  <thead>
      <tr>
          <th>工具名称</th>
          <th>核心优势</th>
          <th>单机单卡适配性</th>
          <th>支持技术类型</th>
          <th>易用性</th>
          <th>训练速度（相对值）</th>
          <th>显存优化率</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Unsloth</td>
          <td>极致显存优化 + 超高速度</td>
          <td>极佳</td>
          <td>LoRA/QLoRA/ 全参数微调</td>
          <td>高</td>
          <td>30 倍</td>
          <td>75%</td>
      </tr>
      <tr>
          <td>PEFT（Hugging Face）</td>
          <td>生态完善 + 兼容性强</td>
          <td>一般</td>
          <td>LoRA/Adapter/QLoRA</td>
          <td>中</td>
          <td>1 倍</td>
          <td>30%</td>
      </tr>
      <tr>
          <td>Axolotl</td>
          <td>配置化操作 + 多平台集成</td>
          <td>良好</td>
          <td>全参数 / LoRA/QLoRA</td>
          <td>极高</td>
          <td>1.2 倍</td>
          <td>40%</td>
      </tr>
      <tr>
          <td>LoRAX</td>
          <td>推理优化 + 低延迟部署</td>
          <td>一般</td>
          <td>LoRA 系列</td>
          <td>中</td>
          <td>1.5 倍</td>
          <td>35%</td>
      </tr>
  </tbody>
</table>



  <blockquote>
    <p>测试环境：RTX 4090（24GB），微调 Llama 3.2-1B 模型，序列长度 2048，batch size=1</p>
  </blockquote>

<p>数据来源：Unsloth 社区实测与官方基准测试</p>
<h4 id="工具选型建议">工具选型建议</h4>
<ul>
<li>
<p><strong>优先选 Unsloth</strong>：单机单卡场景下，兼顾速度、显存占用和微调效果的最优解。</p>
</li>
<li>
<p><strong>次选 Axolotl</strong>：需要多模型支持或配置化操作（无需编写大量代码）时选择。</p>
</li>
<li>
<p><strong>谨慎选 PEFT</strong>：仅当需要与 Hugging Face 生态（如 Transformers Pipeline）深度集成时考虑。</p>
</li>
</ul>
<h2 id="二系统环境搭建ubuntu-2204windows-11-双系统适配">二、系统环境搭建（Ubuntu 22.04/Windows 11 双系统适配）</h2>
<h3 id="21-ubuntu-2204-系统配置">2.1 Ubuntu 22.04 系统配置</h3>
<h4 id="211-显卡驱动安装rtx-30904090-示例">2.1.1 显卡驱动安装（RTX 3090/4090 示例）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 1. 卸载旧驱动（避免版本冲突）</span>
</span></span><span style="display:flex;"><span>sudo apt purge nvidia-*
</span></span><span style="display:flex;"><span>sudo apt autoremove
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 添加NVIDIA官方驱动源</span>
</span></span><span style="display:flex;"><span>sudo add-apt-repository ppa:graphics-drivers/ppa
</span></span><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 查看推荐驱动版本（需≥535.xx，确保兼容CUDA 11.8）</span>
</span></span><span style="display:flex;"><span>ubuntu-drivers devices
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 输出示例：recommended: nvidia-driver-550-server（选择推荐版本）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 4. 安装推荐驱动</span>
</span></span><span style="display:flex;"><span>sudo apt install nvidia-driver-550-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 5. 重启系统生效</span>
</span></span><span style="display:flex;"><span>sudo reboot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 6. 验证驱动安装（显示GPU型号、驱动版本、CUDA版本）</span>
</span></span><span style="display:flex;"><span>nvidia-smi
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 预期输出：Driver Version: 550.xx，CUDA Version: 12.4（仅显示，非实际安装）</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="212-cuda-toolkit-118-安装unsloth-最佳兼容版本">2.1.2 CUDA Toolkit 11.8 安装（Unsloth 最佳兼容版本）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 1. 下载CUDA 11.8安装脚本</span>
</span></span><span style="display:flex;"><span>wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 赋予脚本执行权限</span>
</span></span><span style="display:flex;"><span>chmod +x cuda_11.8.0_520.61.05_linux.run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 安装CUDA Toolkit（仅安装工具包，不重复安装驱动）</span>
</span></span><span style="display:flex;"><span>sudo ./cuda_11.8.0_520.61.05_linux.run --toolkit --override
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 4. 配置CUDA环境变量（写入.bashrc实现持久化）</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#39;export PATH=/usr/local/cuda-11.8/bin:$PATH&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#39;export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source</span> ~/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 5. 验证CUDA安装（显示版本11.8）</span>
</span></span><span style="display:flex;"><span>nvcc -V
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 预期输出：release 11.8, V11.8.89</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-windows-11-系统配置">2.2 Windows 11 系统配置</h3>
<h4 id="221-显卡驱动与-cuda-安装">2.2.1 显卡驱动与 CUDA 安装</h4>
<ol>
<li>
<p><strong>驱动下载</strong>：访问 NVIDIA 官网（<a href="https://www.nvidia.com/" target="_blank">https://www.nvidia</a>
<a href="https://www.nvidia.com/" target="_blank">.com/</a>
），选择 GPU 型号（如 RTX 4090），下载 Windows 驱动（版本≥535.xx）。</p>
</li>
<li>
<p><strong>驱动安装</strong>：双击安装程序，选择 “精简安装”，完成后重启电脑。</p>
</li>
<li>
<p><strong>CUDA 11.8 安装</strong>：</p>
</li>
</ol>
<ul>
<li>
<ul>
<li>下载地址：<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">https://developer.nvidi</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">a.com</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">/cuda</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">-11-8</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">-0-do</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">wnloa</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">d-arc</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">hive</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">?targe</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">t_os=</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">Windo</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">ws&amp;ta</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">rget_</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">arch=</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">x86_6</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">4&amp;tar</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">get_v</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">ersio</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">n=11&amp;</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">targe</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">t_typ</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">e=exe</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">_loca</a>
<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=11&amp;target_type=exe_local" target="_blank">l</a>
</li>
</ul>
</li>
<li>
<ul>
<li>运行安装程序，选择 “自定义安装”，仅勾选 “CUDA Toolkit 11.8”，取消勾选 “NVIDIA GeForce Experience”，安装路径默认（C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8）。</li>
</ul>
</li>
</ul>
<ol>
<li><strong>验证</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>打开命令提示符（CMD），输入nvidia-smi，查看驱动版本与 CUDA 版本。</li>
</ul>
</li>
<li>
<ul>
<li>输入nvcc -V，确认输出 CUDA 11.8 版本信息。</li>
</ul>
</li>
</ul>
<h4 id="222-wsl2-环境配置推荐-windows-用户兼容-linux-工具链">2.2.2 WSL2 环境配置（推荐 Windows 用户，兼容 Linux 工具链）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 1. 管理员身份打开PowerShell，启用WSL2</span>
</span></span><span style="display:flex;"><span>wsl --install
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 安装完成后重启电脑</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 安装Ubuntu 22.04子系统</span>
</span></span><span style="display:flex;"><span>wsl --install -d Ubuntu-22.04
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 首次启动设置Ubuntu用户名和密码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 进入WSL2环境（后续操作同Ubuntu系统）</span>
</span></span><span style="display:flex;"><span>wsl
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-python-环境与依赖配置">2.3 Python 环境与依赖配置</h3>
<h4 id="231-虚拟环境创建避免依赖冲突">2.3.1 虚拟环境创建（避免依赖冲突）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 1. 安装virtualenv（Ubuntu/WSL/Windows通用）</span>
</span></span><span style="display:flex;"><span>pip install virtualenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 创建虚拟环境（命名为unsloth-env，指定Python 3.10）</span>
</span></span><span style="display:flex;"><span>virtualenv unsloth-env -p python3.10
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 注：Unsloth推荐Python 3.10，Ubuntu需提前安装：sudo apt install python3.10 python3.10-venv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 激活虚拟环境</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Ubuntu/WSL</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source</span> unsloth-env/bin/activate
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Windows CMD</span>
</span></span><span style="display:flex;"><span>unsloth-env<span style="color:#f1fa8c">\S</span>cripts<span style="color:#f1fa8c">\a</span>ctivate.bat
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Windows PowerShell</span>
</span></span><span style="display:flex;"><span>.<span style="color:#f1fa8c">\u</span>nsloth-env<span style="color:#f1fa8c">\S</span>cripts<span style="color:#f1fa8c">\A</span>ctivate.ps1
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 激活后终端前缀显示：(unsloth-env)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="232-依赖精确安装版本锁定确保兼容性">2.3.2 依赖精确安装（版本锁定，确保兼容性）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span># <span style="color:#bd93f9">1.</span> 创建依赖清单文件（requirements.txt）
</span></span><span style="display:flex;"><span>cat <span style="color:#ff79c6">&gt;</span> requirements.txt <span style="color:#ff79c6">&lt;&lt;</span> EOF
</span></span><span style="display:flex;"><span>unsloth<span style="color:#ff79c6">==</span><span style="color:#bd93f9">2024.5</span>
</span></span><span style="display:flex;"><span>transformers<span style="color:#ff79c6">==</span><span style="color:#bd93f9">4.41</span>.<span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>peft<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.11</span>.<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>accelerate<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.30</span>.<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>bitsandbytes<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.43</span>.<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>datasets<span style="color:#ff79c6">==</span><span style="color:#bd93f9">2.19</span>.<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>tokenizers<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.19</span>.<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>torch<span style="color:#ff79c6">==</span><span style="color:#bd93f9">2.2</span>.<span style="color:#bd93f9">2</span><span style="color:#ff79c6">+</span>cu118
</span></span><span style="display:flex;"><span>torchvision<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.17</span>.<span style="color:#bd93f9">2</span><span style="color:#ff79c6">+</span>cu118
</span></span><span style="display:flex;"><span>torchaudio<span style="color:#ff79c6">==</span><span style="color:#bd93f9">2.2</span>.<span style="color:#bd93f9">2</span><span style="color:#ff79c6">+</span>cu118
</span></span><span style="display:flex;"><span>wandb<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.16</span>.<span style="color:#bd93f9">6</span>
</span></span><span style="display:flex;"><span>tensorboard<span style="color:#ff79c6">==</span><span style="color:#bd93f9">2.16</span>.<span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>jsonlines<span style="color:#ff79c6">==</span><span style="color:#bd93f9">4.0</span>.<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>sentencepiece<span style="color:#ff79c6">==</span><span style="color:#bd93f9">0.2</span>.<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#bd93f9">2.</span> 安装依赖（指定CUDA <span style="color:#bd93f9">11.8</span>版本的PyTorch）
</span></span><span style="display:flex;"><span>pip install <span style="color:#ff79c6">-</span>r requirements.txt <span style="color:#ff79c6">--</span>extra<span style="color:#ff79c6">-</span>index<span style="color:#ff79c6">-</span>url https<span style="color:#ff79c6">:</span><span style="color:#6272a4">//download.pytorch.org/whl/cu118
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span># <span style="color:#bd93f9">3.</span> 验证依赖安装
</span></span><span style="display:flex;"><span># 检查Unsloth版本
</span></span><span style="display:flex;"><span>python <span style="color:#ff79c6">-</span>c <span style="color:#f1fa8c">&#34;import unsloth; print(f&#39;Unsloth version: {unsloth.__version__}&#39;)&#34;</span>
</span></span><span style="display:flex;"><span># 检查PyTorch与CUDA关联（需显示True和11.<span style="color:#bd93f9">8</span>）
</span></span><span style="display:flex;"><span>python <span style="color:#ff79c6">-</span>c <span style="color:#f1fa8c">&#34;import torch; print(f&#39;Torch version: {torch.__version__}&#39;); print(f&#39;Torch CUDA available: {torch.cuda.is_available()}&#39;); print(f&#39;Torch CUDA version: {torch.version.cuda}&#39;)&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="三数据集本地化处理">三、数据集本地化处理</h2>
<h3 id="31-数据集结构与格式">3.1 数据集结构与格式</h3>
<h4 id="311-目录结构">3.1.1 目录结构</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dataset/
</span></span><span style="display:flex;"><span>├── train.json  <span style="color:#6272a4"># 训练集（建议≥100条样本，保证微调效果）</span>
</span></span><span style="display:flex;"><span>└── test.json   <span style="color:#6272a4"># 测试集（约为训练集规模的20%，用于验证）</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="312-样本格式chatml-标准以医疗问答为例">3.1.2 样本格式（ChatML 标准，以医疗问答为例）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;conversations&#34;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;system&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;你是专业医疗问答助手，回答需基于医学常识，避免误导用户&#34;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;糖尿病患者可以吃水果吗？&#34;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;assistant&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;糖尿病患者可以适量吃水果，但需注意以下几点：1. 选择低GI（血糖生成指数）水果，如苹果、梨、柚子、草莓等，避免高GI水果如西瓜、荔枝、榴莲；2. 控制食用量，每天建议200-300克，分次食用，避免一次性大量摄入；3. 食用时间选择两餐之间（如上午10点、下午3点），避免餐后立即食用，防止血糖叠加升高；4. 食用水果后需监测血糖，根据自身血糖变化调整种类和量；5. 若血糖控制不佳（空腹血糖&gt;8mmol/L或餐后2小时血糖&gt;11.1mmol/L），建议暂时避免食用水果，优先控制血糖。&#34;</span>}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;conversations&#34;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;system&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;你是专业医疗问答助手，回答需基于医学常识，避免误导用户&#34;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;感冒时应该多喝水吗？&#34;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f1fa8c">&#34;role&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;assistant&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;感冒时建议适量多喝水，原因如下：1. 补充水分：感冒常伴随发热、出汗，多喝水可补充身体流失的水分，防止脱水；2. 稀释痰液：有助于稀释呼吸道内的痰液，促进痰液排出，缓解咳嗽、鼻塞等症状；3. 调节体温：通过出汗散热，帮助降低体温；4. 促进代谢：加速身体新陈代谢，帮助排出体内毒素和病毒。但需注意：1. 饮水量适中，一般成年人每天1500-2000毫升即可，避免过量饮水增加肾脏负担；2. 特殊人群如心肾功能不全者，需根据医生建议控制饮水量；3. 可选择温开水、淡盐水或蜂蜜水（1岁以下婴儿禁用），避免饮用含糖量高的饮料。&#34;</span>}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-数据集加载与清洗代码">3.2 数据集加载与清洗代码</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> datasets <span style="color:#ff79c6">import</span> Dataset
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> jsonlines
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">load_local_json_dataset</span>(train_path, test_path):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;加载本地JSON数据集并清洗格式错误样本&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 读取训练集</span>
</span></span><span style="display:flex;"><span>    train_data <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> jsonlines<span style="color:#ff79c6">.</span>open(train_path, mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;r&#39;</span>) <span style="color:#ff79c6">as</span> reader:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> obj <span style="color:#ff79c6">in</span> reader:
</span></span><span style="display:flex;"><span>            train_data<span style="color:#ff79c6">.</span>append(obj)
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 读取测试集</span>
</span></span><span style="display:flex;"><span>    test_data <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> jsonlines<span style="color:#ff79c6">.</span>open(test_path, mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;r&#39;</span>) <span style="color:#ff79c6">as</span> reader:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> obj <span style="color:#ff79c6">in</span> reader:
</span></span><span style="display:flex;"><span>            test_data<span style="color:#ff79c6">.</span>append(obj)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 数据清洗：过滤缺少关键角色（system/user/assistant）或空内容的样本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">clean_data</span>(raw_data):
</span></span><span style="display:flex;"><span>        cleaned <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> item <span style="color:#ff79c6">in</span> raw_data:
</span></span><span style="display:flex;"><span>            conv <span style="color:#ff79c6">=</span> item<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;conversations&#34;</span>, [])
</span></span><span style="display:flex;"><span>            roles <span style="color:#ff79c6">=</span> [turn<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;role&#34;</span>) <span style="color:#ff79c6">for</span> turn <span style="color:#ff79c6">in</span> conv]
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># 检查是否包含所有关键角色</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> {<span style="color:#f1fa8c">&#34;system&#34;</span>, <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;assistant&#34;</span>}<span style="color:#ff79c6">.</span>issubset(<span style="color:#8be9fd;font-style:italic">set</span>(roles)):
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># 检查所有content非空</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">all</span>(turn<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;content&#34;</span>, <span style="color:#f1fa8c">&#34;&#34;</span>)<span style="color:#ff79c6">.</span>strip() <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">for</span> turn <span style="color:#ff79c6">in</span> conv):
</span></span><span style="display:flex;"><span>                    cleaned<span style="color:#ff79c6">.</span>append({<span style="color:#f1fa8c">&#34;conversations&#34;</span>: conv})
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> cleaned
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cleaned_train <span style="color:#ff79c6">=</span> clean_data(train_data)
</span></span><span style="display:flex;"><span>    cleaned_test <span style="color:#ff79c6">=</span> clean_data(test_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 转换为datasets.Dataset格式（便于后续处理）</span>
</span></span><span style="display:flex;"><span>    train_dataset <span style="color:#ff79c6">=</span> Dataset<span style="color:#ff79c6">.</span>from_list(cleaned_train)
</span></span><span style="display:flex;"><span>    test_dataset <span style="color:#ff79c6">=</span> Dataset<span style="color:#ff79c6">.</span>from_list(cleaned_test)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> {<span style="color:#f1fa8c">&#34;train&#34;</span>: train_dataset, <span style="color:#f1fa8c">&#34;test&#34;</span>: test_dataset}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 加载数据集（替换为实际路径）</span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#ff79c6">=</span> load_local_json_dataset(
</span></span><span style="display:flex;"><span>    train_path<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./dataset/train.json&#34;</span>,
</span></span><span style="display:flex;"><span>    test_path<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./dataset/test.json&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 验证加载结果</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;训练集样本数量：</span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(dataset[<span style="color:#f1fa8c">&#39;train&#39;</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;测试集样本数量：</span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(dataset[<span style="color:#f1fa8c">&#39;test&#39;</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;训练集第一条样本：</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">{</span>json<span style="color:#ff79c6">.</span>dumps(dataset[<span style="color:#f1fa8c">&#39;train&#39;</span>][<span style="color:#bd93f9">0</span>], indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>, ensure_ascii<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-企业知识库场景数据增强可选">3.3 企业知识库场景数据增强（可选）</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth.dataprep.synthetic <span style="color:#ff79c6">import</span> prepare_qa_generation
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth.chat_templates <span style="color:#ff79c6">import</span> apply_chat_template
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 从企业文档生成QA样本（支持TXT/PDF格式）</span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#ff79c6">=</span> prepare_qa_generation(
</span></span><span style="display:flex;"><span>    output_folder<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;company_kb_dataset&#34;</span>,  <span style="color:#6272a4"># 输出目录</span>
</span></span><span style="display:flex;"><span>    max_generation_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">512</span>,           <span style="color:#6272a4"># 单条回答最大长度</span>
</span></span><span style="display:flex;"><span>    temperature<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.7</span>,                     <span style="color:#6272a4"># 生成随机性（0-1）</span>
</span></span><span style="display:flex;"><span>    overlap<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>,                          <span style="color:#6272a4"># 文档片段重叠度（避免信息丢失）</span>
</span></span><span style="display:flex;"><span>    default_num_pairs<span style="color:#ff79c6">=</span><span style="color:#bd93f9">25</span>,                <span style="color:#6272a4"># 每个文档生成25组QA</span>
</span></span><span style="display:flex;"><span>    cleanup_threshold<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.85</span>               <span style="color:#6272a4"># 过滤低质量样本（0-1）</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 应用ChatML模板统一格式</span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#ff79c6">=</span> apply_chat_template(
</span></span><span style="display:flex;"><span>    dataset,
</span></span><span style="display:flex;"><span>    tokenizer<span style="color:#ff79c6">=</span>tokenizer,  <span style="color:#6272a4"># 后续加载的模型Tokenizer</span>
</span></span><span style="display:flex;"><span>    chat_template<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;chatml&#34;</span>,
</span></span><span style="display:flex;"><span>    default_system_message<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;你是公司内部知识库助手，仅回答与公司业务相关的问题&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="四模型配置与预加载">四、模型配置与预加载</h2>
<h3 id="41-模型缓存路径设置避免重复下载">4.1 模型缓存路径设置（避免重复下载）</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># Ubuntu/WSL：设置缓存路径（替换为实际路径）</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">TRANSFORMERS_CACHE</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/home/your_username/.cache/huggingface/hub&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 持久化配置（写入.bashrc）</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;export TRANSFORMERS_CACHE=</span><span style="color:#8be9fd;font-style:italic">$TRANSFORMERS_CACHE</span><span style="color:#f1fa8c">&#34;</span> &gt;&gt; ~/.bashrc
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source</span> ~/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Windows CMD：设置缓存路径（替换为实际路径）</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#8be9fd;font-style:italic">TRANSFORMERS_CACHE</span><span style="color:#ff79c6">=</span>D:<span style="color:#f1fa8c">\h</span>uggingface_cache
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 持久化配置（管理员身份）</span>
</span></span><span style="display:flex;"><span>setx TRANSFORMERS_CACHE <span style="color:#f1fa8c">&#34;%TRANSFORMERS_CACHE%&#34;</span> /M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Windows PowerShell：设置缓存路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">$env</span>:TRANSFORMERS_CACHE<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;D:\huggingface_cache&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 持久化配置</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Environment<span style="color:#ff79c6">]</span>::SetEnvironmentVariable<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;TRANSFORMERS_CACHE&#34;</span>, <span style="color:#f1fa8c">&#34;D:\huggingface_cache&#34;</span>, <span style="color:#f1fa8c">&#34;Machine&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-模型预加载提前下载权重节省训练时间">4.2 模型预加载（提前下载权重，节省训练时间）</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth <span style="color:#ff79c6">import</span> FastLanguageModel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> transformers <span style="color:#ff79c6">import</span> AutoTokenizer
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 选择模型（以Llama 3.2-1B为例，24GB显存可支持）</span>
</span></span><span style="display:flex;"><span>model_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;meta-llama/Llama-3.2-1B-Instruct&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 1. 下载Tokenizer</span>
</span></span><span style="display:flex;"><span>tokenizer <span style="color:#ff79c6">=</span> AutoTokenizer<span style="color:#ff79c6">.</span>from_pretrained(model_name)
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 保存Tokenizer到本地（可选）</span>
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#ff79c6">.</span>save_pretrained(<span style="color:#f1fa8c">&#34;./llama-3.2-1b-tokenizer&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Tokenizer保存路径：./llama-3.2-1b-tokenizer&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 下载模型权重（加载到CPU，不占用GPU显存）</span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>from_pretrained(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span>model_name,
</span></span><span style="display:flex;"><span>    max_seq_length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2048</span>,       <span style="color:#6272a4"># 序列最大长度</span>
</span></span><span style="display:flex;"><span>    load_in_4bit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>,        <span style="color:#6272a4"># 不启用量化（仅下载）</span>
</span></span><span style="display:flex;"><span>    device_map<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;cpu&#34;</span>,          <span style="color:#6272a4"># 加载到CPU</span>
</span></span><span style="display:flex;"><span>    cache_dir<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;TRANSFORMERS_CACHE&#34;</span>)  <span style="color:#6272a4"># 使用自定义缓存路径</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 保存模型到本地（可选，后续直接加载）</span>
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>save_pretrained(<span style="color:#f1fa8c">&#34;./llama-3.2-1b-local&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;模型保存路径：./llama-3.2-1b-local&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 后续加载本地模型示例</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># model, tokenizer = FastLanguageModel.from_pretrained(</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#     model_name=&#34;./llama-3.2-1b-local&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#     max_seq_length=2048,</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#     load_in_4bit=True,</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#     device_map=&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># )</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-模型加载配置分场景适配显存">4.3 模型加载配置（分场景适配显存）</h3>
<h4 id="431-16gb-显存配置如-rtx-4080qlora-微调">4.3.1 16GB 显存配置（如 RTX 4080，QLoRA 微调）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth <span style="color:#ff79c6">import</span> FastLanguageModel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model, tokenizer <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>from_pretrained(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;meta-llama/Llama-3.2-1B-Instruct&#34;</span>,  <span style="color:#6272a4"># 或本地路径</span>
</span></span><span style="display:flex;"><span>    max_seq_length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2048</span>,
</span></span><span style="display:flex;"><span>    load_in_4bit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,                  <span style="color:#6272a4"># 启用4-bit量化（降低显存占用）</span>
</span></span><span style="display:flex;"><span>    use_gradient_checkpointing<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;unsloth&#34;</span>,<span style="color:#6272a4"># Unsloth优化版梯度检查点</span>
</span></span><span style="display:flex;"><span>    max_lora_rank<span style="color:#ff79c6">=</span><span style="color:#bd93f9">16</span>,                   <span style="color:#6272a4"># 降低LoRA秩，减少显存使用</span>
</span></span><span style="display:flex;"><span>    device_map<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 配置LoRA微调</span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>get_peft_model(
</span></span><span style="display:flex;"><span>    model,
</span></span><span style="display:flex;"><span>    r<span style="color:#ff79c6">=</span><span style="color:#bd93f9">16</span>,                               <span style="color:#6272a4"># LoRA秩（与max_lora_rank一致）</span>
</span></span><span style="display:flex;"><span>    target_modules<span style="color:#ff79c6">=</span>(<span style="color:#f1fa8c">&#34;q_proj&#34;</span>, <span style="color:#f1fa8c">&#34;k_proj&#34;</span>, <span style="color:#f1fa8c">&#34;v_proj&#34;</span>, <span style="color:#f1fa8c">&#34;o_proj&#34;</span>, <span style="color:#f1fa8c">&#34;gate_proj&#34;</span>, <span style="color:#f1fa8c">&#34;up_proj&#34;</span>, <span style="color:#f1fa8c">&#34;down_proj&#34;</span>),
</span></span><span style="display:flex;"><span>    lora_alpha<span style="color:#ff79c6">=</span><span style="color:#bd93f9">32</span>,                      <span style="color:#6272a4"># LoRA缩放因子</span>
</span></span><span style="display:flex;"><span>    lora_dropout<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.05</span>,                  <span style="color:#6272a4">#  dropout比例（防止过拟合）</span>
</span></span><span style="display:flex;"><span>    bias<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;none&#34;</span>,
</span></span><span style="display:flex;"><span>    random_state<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3407</span>                   <span style="color:#6272a4"># 固定随机种子（保证可复现）</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="432-24gb-显存配置如-rtx-4090全参数微调">4.3.2 24GB 显存配置（如 RTX 4090，全参数微调）</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth <span style="color:#ff79c6">import</span> FastLanguageModel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model, tokenizer <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>from_pretrained(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;mistralai/Mistral-7B-Instruct-v0.3&#34;</span>,  <span style="color:#6272a4"># 7B模型，全参数微调</span>
</span></span><span style="display:flex;"><span>    max_seq_length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2048</span>,
</span></span><span style="display:flex;"><span>    load_in_8bit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,                  <span style="color:#6272a4"># 8-bit量化（平衡精度与显存）</span>
</span></span><span style="display:flex;"><span>    use_gradient_checkpointing<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;unsloth&#34;</span>,
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;paged_adamw_8bit&#34;</span>,       <span style="color:#6272a4"># 分页优化器（降低显存占用）</span>
</span></span><span style="display:flex;"><span>    device_map<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 全参数微调无需PEFT配置，直接切换训练模式</span>
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>train()
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="五微调实战流程">五、微调实战流程</h2>
<h3 id="51-训练参数配置">5.1 训练参数配置</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> transformers <span style="color:#ff79c6">import</span> TrainingArguments, Trainer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>training_args <span style="color:#ff79c6">=</span> TrainingArguments(
</span></span><span style="display:flex;"><span>    output_dir<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./unsloth_finetune&#34;</span>,    <span style="color:#6272a4"># 训练结果输出目录</span>
</span></span><span style="display:flex;"><span>    per_device_train_batch_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,      <span style="color:#6272a4"># 单卡batch size（16GB显存建议1，24GB可尝试2）</span>
</span></span><span style="display:flex;"><span>    gradient_accumulation_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">8</span>,      <span style="color:#6272a4"># 梯度累积（等效batch size=1*8=8）</span>
</span></span><span style="display:flex;"><span>    learning_rate<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2e-5</span>,                 <span style="color:#6272a4"># 学习率（全参数微调建议1e-5~3e-5）</span>
</span></span><span style="display:flex;"><span>    num_train_epochs<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>,                 <span style="color:#6272a4"># 训练轮次（避免过拟合）</span>
</span></span><span style="display:flex;"><span>    logging_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>,                   <span style="color:#6272a4"># 日志输出间隔（每10步打印一次损失）</span>
</span></span><span style="display:flex;"><span>    save_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">100</span>,                     <span style="color:#6272a4"># 模型保存间隔（每100步保存一次）</span>
</span></span><span style="display:flex;"><span>    fp16<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,                          <span style="color:#6272a4"># 启用混合精度训练（加速且省显存）</span>
</span></span><span style="display:flex;"><span>    optim<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;paged_adamw_8bit&#34;</span>,           <span style="color:#6272a4"># 8-bit优化器（降低显存占用）</span>
</span></span><span style="display:flex;"><span>    report_to<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;none&#34;</span>,                   <span style="color:#6272a4"># 暂不启用监控工具（后续单独配置）</span>
</span></span><span style="display:flex;"><span>    evaluation_strategy<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;steps&#34;</span>,        <span style="color:#6272a4"># 按步验证</span>
</span></span><span style="display:flex;"><span>    eval_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">100</span>,                     <span style="color:#6272a4"># 验证间隔（每100步验证一次）</span>
</span></span><span style="display:flex;"><span>    load_best_model_at_end<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>         <span style="color:#6272a4"># 训练结束加载最优模型</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-启动训练">5.2 启动训练</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># 初始化Trainer</span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff79c6">=</span> Trainer(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    args<span style="color:#ff79c6">=</span>training_args,
</span></span><span style="display:flex;"><span>    train_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    eval_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;test&#34;</span>],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 开始训练</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;训练启动，日志将按配置间隔输出...&#34;</span>)
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>train()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 保存最终模型</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>save_model(<span style="color:#f1fa8c">&#34;./fine_tuned_model&#34;</span>)
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#ff79c6">.</span>save_pretrained(<span style="color:#f1fa8c">&#34;./fine_tuned_model&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;微调完成，模型保存路径：./fine_tuned_model&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="六训练监控工具配置">六、训练监控工具配置</h2>
<h3 id="61-tensorboard-配置">6.1 TensorBoard 配置</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> torch.utils.tensorboard <span style="color:#ff79c6">import</span> SummaryWriter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 创建日志目录</span>
</span></span><span style="display:flex;"><span>tb_writer <span style="color:#ff79c6">=</span> SummaryWriter(log_dir<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./unsloth_finetune/tensorboard&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 定义监控回调（记录损失、学习率）</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">tb_callback</span>(trainer, args, state, control, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> state<span style="color:#ff79c6">.</span>global_step <span style="color:#ff79c6">%</span> args<span style="color:#ff79c6">.</span>logging_steps <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 记录训练损失</span>
</span></span><span style="display:flex;"><span>        train_loss <span style="color:#ff79c6">=</span> state<span style="color:#ff79c6">.</span>log_history[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;loss&#34;</span>, <span style="color:#bd93f9">0.0</span>)
</span></span><span style="display:flex;"><span>        tb_writer<span style="color:#ff79c6">.</span>add_scalar(<span style="color:#f1fa8c">&#34;Train/Loss&#34;</span>, train_loss, state<span style="color:#ff79c6">.</span>global_step)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 记录学习率</span>
</span></span><span style="display:flex;"><span>        lr <span style="color:#ff79c6">=</span> trainer<span style="color:#ff79c6">.</span>optimizer<span style="color:#ff79c6">.</span>param_groups[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#34;lr&#34;</span>]
</span></span><span style="display:flex;"><span>        tb_writer<span style="color:#ff79c6">.</span>add_scalar(<span style="color:#f1fa8c">&#34;Train/Learning_Rate&#34;</span>, lr, state<span style="color:#ff79c6">.</span>global_step)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 记录验证损失（若有）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;eval_loss&#34;</span> <span style="color:#ff79c6">in</span> state<span style="color:#ff79c6">.</span>log_history[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]:
</span></span><span style="display:flex;"><span>            eval_loss <span style="color:#ff79c6">=</span> state<span style="color:#ff79c6">.</span>log_history[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>][<span style="color:#f1fa8c">&#34;eval_loss&#34;</span>]
</span></span><span style="display:flex;"><span>            tb_writer<span style="color:#ff79c6">.</span>add_scalar(<span style="color:#f1fa8c">&#34;Eval/Loss&#34;</span>, eval_loss, state<span style="color:#ff79c6">.</span>global_step)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 重新初始化Trainer（添加回调）</span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff79c6">=</span> Trainer(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    args<span style="color:#ff79c6">=</span>training_args,
</span></span><span style="display:flex;"><span>    train_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    eval_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;test&#34;</span>],
</span></span><span style="display:flex;"><span>    callbacks<span style="color:#ff79c6">=</span>[tb_callback]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 启动训练后，新终端执行TensorBoard（替换为实际路径）</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># tensorboard --logdir ./unsloth_finetune/tensorboard</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 浏览器访问：http://localhost:6006</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="62-wandb-配置">6.2 WandB 配置</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># 1. 安装并登录WandB（终端执行）</span>
</span></span><span style="display:flex;"><span>pip install wandb
</span></span><span style="display:flex;"><span>wandb login
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 按提示输入API密钥（从WandB官网：https://wandb.ai/settings获取）</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> wandb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 初始化WandB项目</span>
</span></span><span style="display:flex;"><span>wandb<span style="color:#ff79c6">.</span>init(
</span></span><span style="display:flex;"><span>    project<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;unsloth-single-gpu-finetune&#34;</span>,  <span style="color:#6272a4"># 项目名称（自定义）</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;llama-3.2-1b-medical-qa&#34;</span>,         <span style="color:#6272a4"># 实验名称（自定义）</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#ff79c6">=</span>{                                <span style="color:#6272a4"># 记录实验参数（便于复现）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;model_name&#34;</span>: <span style="color:#f1fa8c">&#34;meta-llama/Llama-3.2-1B-Instruct&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;batch_size&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;gradient_accumulation_steps&#34;</span>: <span style="color:#bd93f9">8</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;learning_rate&#34;</span>: <span style="color:#bd93f9">2e-5</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;epochs&#34;</span>: <span style="color:#bd93f9">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;max_seq_length&#34;</span>: <span style="color:#bd93f9">2048</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 配置TrainingArguments（启用WandB报告）</span>
</span></span><span style="display:flex;"><span>training_args<span style="color:#ff79c6">.</span>report_to <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;wandb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 重新初始化Trainer</span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff79c6">=</span> Trainer(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    args<span style="color:#ff79c6">=</span>training_args,
</span></span><span style="display:flex;"><span>    train_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    eval_dataset<span style="color:#ff79c6">=</span>dataset[<span style="color:#f1fa8c">&#34;test&#34;</span>],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 启动训练</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>train()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 训练结束后关闭WandB</span>
</span></span><span style="display:flex;"><span>wandb<span style="color:#ff79c6">.</span>finish()
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 浏览器访问WandB项目页面查看监控：https://wandb.ai/你的用户名/unsloth-single-gpu-finetune</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="七模型部署与测试">七、模型部署与测试</h2>
<h3 id="71-本地推理测试">7.1 本地推理测试</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth <span style="color:#ff79c6">import</span> FastLanguageModel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 加载微调后的模型</span>
</span></span><span style="display:flex;"><span>model, tokenizer <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>from_pretrained(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./fine_tuned_model&#34;</span>,  <span style="color:#6272a4"># 微调后模型路径</span>
</span></span><span style="display:flex;"><span>    max_seq_length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2048</span>,
</span></span><span style="display:flex;"><span>    load_in_4bit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>    device_map<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">generate_response</span>(prompt, system_prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;你是专业医疗问答助手&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;生成模型回复&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 构建对话格式</span>
</span></span><span style="display:flex;"><span>    messages <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>        {<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;system&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: system_prompt},
</span></span><span style="display:flex;"><span>        {<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: prompt}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 编码输入</span>
</span></span><span style="display:flex;"><span>    inputs <span style="color:#ff79c6">=</span> tokenizer<span style="color:#ff79c6">.</span>apply_chat_template(
</span></span><span style="display:flex;"><span>        messages,
</span></span><span style="display:flex;"><span>        add_generation_prompt<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        return_tensors<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;pt&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#ff79c6">.</span>to(model<span style="color:#ff79c6">.</span>device)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 生成回复</span>
</span></span><span style="display:flex;"><span>    outputs <span style="color:#ff79c6">=</span> model<span style="color:#ff79c6">.</span>generate(
</span></span><span style="display:flex;"><span>        inputs,
</span></span><span style="display:flex;"><span>        max_new_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">512</span>,  <span style="color:#6272a4"># 单条回复最大长度</span>
</span></span><span style="display:flex;"><span>        temperature<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.7</span>,     <span style="color:#6272a4"># 随机性（0-1，越低越稳定）</span>
</span></span><span style="display:flex;"><span>        top_p<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.9</span>,           <span style="color:#6272a4"># 采样阈值（过滤低概率词）</span>
</span></span><span style="display:flex;"><span>        do_sample<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,      <span style="color:#6272a4"># 启用采样生成（避免重复）</span>
</span></span><span style="display:flex;"><span>        pad_token_id<span style="color:#ff79c6">=</span>tokenizer<span style="color:#ff79c6">.</span>eos_token_id
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 解码输出（去除特殊字符）</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#ff79c6">=</span> tokenizer<span style="color:#ff79c6">.</span>decode(outputs[<span style="color:#bd93f9">0</span>], skip_special_tokens<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 提取assistant回复</span>
</span></span><span style="display:flex;"><span>    assistant_response <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>split(<span style="color:#f1fa8c">&#34;assistant&#34;</span>)[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> assistant_response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 测试推理</span>
</span></span><span style="display:flex;"><span>test_prompts <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;高血压患者可以吃鸡蛋吗？&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;感冒发烧到38.5℃需要吃退烧药吗？&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> prompt <span style="color:#ff79c6">in</span> test_prompts:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;用户：</span><span style="color:#f1fa8c">{</span>prompt<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    response <span style="color:#ff79c6">=</span> generate_response(prompt)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;助手：</span><span style="color:#f1fa8c">{</span>response<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="72-flask-api-服务部署支持-http-调用">7.2 Flask API 服务部署（支持 HTTP 调用）</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># 安装Flask依赖</span>
</span></span><span style="display:flex;"><span>pip install flask flask<span style="color:#ff79c6">-</span>cors
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, request, jsonify
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> flask_cors <span style="color:#ff79c6">import</span> CORS
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unsloth <span style="color:#ff79c6">import</span> FastLanguageModel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 初始化Flask应用</span>
</span></span><span style="display:flex;"><span>app <span style="color:#ff79c6">=</span> Flask(<span style="color:#8be9fd;font-style:italic">__name__</span>)
</span></span><span style="display:flex;"><span>CORS(app)  <span style="color:#6272a4"># 允许跨域请求（前端调用）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 加载微调后的模型（服务启动时加载）</span>
</span></span><span style="display:flex;"><span>model, tokenizer <span style="color:#ff79c6">=</span> FastLanguageModel<span style="color:#ff79c6">.</span>from_pretrained(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;./fine_tuned_model&#34;</span>,
</span></span><span style="display:flex;"><span>    max_seq_length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2048</span>,
</span></span><span style="display:flex;"><span>    load_in_4bit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>    device_map<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 定义推理接口（POST方法）</span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#f1fa8c">&#34;/generate&#34;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">generate</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 获取请求参数</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>json
</span></span><span style="display:flex;"><span>        prompt <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;prompt&#34;</span>, <span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        system_prompt <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;system_prompt&#34;</span>, <span style="color:#f1fa8c">&#34;你是专业医疗问答助手&#34;</span>)
</span></span><span style="display:flex;"><span>        max_new_tokens <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;max_new_tokens&#34;</span>, <span style="color:#bd93f9">512</span>)
</span></span><span style="display:flex;"><span>        temperature <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;temperature&#34;</span>, <span style="color:#bd93f9">0.7</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 校验参数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> prompt<span style="color:#ff79c6">.</span>strip():
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#34;code&#34;</span>: <span style="color:#bd93f9">400</span>, <span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;prompt不能为空&#34;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 生成回复</span>
</span></span><span style="display:flex;"><span>        messages <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;system&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: system_prompt},
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: prompt}
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        inputs <span style="color:#ff79c6">=</span> tokenizer<span style="color:#ff79c6">.</span>apply_chat_template(
</span></span><span style="display:flex;"><span>            messages,
</span></span><span style="display:flex;"><span>            add_generation_prompt<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>            return_tensors<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;pt&#34;</span>
</span></span><span style="display:flex;"><span>        )<span style="color:#ff79c6">.</span>to(model<span style="color:#ff79c6">.</span>device)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        outputs <span style="color:#ff79c6">=</span> model<span style="color:#ff79c6">.</span>generate(
</span></span><span style="display:flex;"><span>            inputs,
</span></span><span style="display:flex;"><span>            max_new_tokens<span style="color:#ff79c6">=</span>max_new_tokens,
</span></span><span style="display:flex;"><span>            temperature<span style="color:#ff79c6">=</span>temperature,
</span></span><span style="display:flex;"><span>            top_p<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.9</span>,
</span></span><span style="display:flex;"><span>            do_sample<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>            pad_token_id<span style="color:#ff79c6">=</span>tokenizer<span style="color:#ff79c6">.</span>eos_token_id
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> tokenizer<span style="color:#ff79c6">.</span>decode(outputs[<span style="color:#bd93f9">0</span>], skip_special_tokens<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>        assistant_response <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>split(<span style="color:#f1fa8c">&#34;assistant&#34;</span>)[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 返回结果</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;code&#34;</span>: <span style="color:#bd93f9">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;success&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;data&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;prompt&#34;</span>: prompt,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;response&#34;</span>: assistant_response
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 异常处理</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;code&#34;</span>: <span style="color:#bd93f9">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;服务器错误：</span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">str</span>(e)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>        }), <span style="color:#bd93f9">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 启动服务（生产环境建议用Gunicorn，此处为测试用）</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">__name__</span> <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#ff79c6">.</span>run(host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;0.0.0.0&#34;</span>, port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5000</span>, debug<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># API测试命令（终端执行，替换为实际参数）</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># curl -X POST http://localhost:5000/generate \</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># -H &#34;Content-Type: application/json&#34; \</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># -d &#39;{&#34;prompt&#34;:&#34;高血压患者可以吃鸡蛋吗？&#34;, &#34;max_new_tokens&#34;:300, &#34;temperature&#34;:0.6}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="73-导出为-gguf-格式适配-ollama-部署">7.3 导出为 GGUF 格式（适配 Ollama 部署）</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 导出GGUF格式（支持Ollama、 llama.cpp等工具）</span>
</span></span><span style="display:flex;"><span>model.save_pretrained_gguf<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;./exported_model_gguf&#34;</span>,  <span style="color:#6272a4"># 输出目录</span>
</span></span><span style="display:flex;"><span>    tokenizer,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">quantization_method</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;q4_k_m&#34;</span>  <span style="color:#6272a4"># 量化方式（平衡精度与速度）</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Ollama部署命令（终端执行）</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 1. 创建Modelfile</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># FROM ./exported_model_gguf/your_model.gguf</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 2. 构建Ollama模型</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ollama create medical-qa -f Modelfile</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 3. 启动对话</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ollama run medical-qa</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="八常见问题排查与优化">八、常见问题排查与优化</h2>
<h3 id="81-依赖安装问题">8.1 依赖安装问题</h3>
<table>
  <thead>
      <tr>
          <th>问题现象</th>
          <th>解决方案</th>
          <th>操作命令</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>bitsandbytes 安装报错（Windows）</td>
          <td>安装 Windows 适配版本</td>
          <td>pip install bitsandbytes-windows==0.43.0</td>
      </tr>
      <tr>
          <td>PyTorch 与 CUDA 版本不匹配</td>
          <td>卸载后重新安装对应版本</td>
          <td>pip uninstall torch torchvision torchaudio; pip install torch==2.2.2+cu118 torchvision==0.17.2+cu118 torchaudio==2.2.2+cu118 &ndash;extra-index-url <a href="https://download.pytorch.org/whl/cu118" target="_blank">https://download.pytorch.org/whl/cu118</a>
</td>
      </tr>
      <tr>
          <td>Unsloth 安装报错（CUDA 版本过低）</td>
          <td>升级 CUDA 到 11.8+，或安装 CPU 版本（仅测试用）</td>
          <td>pip install unsloth[cpu]==2024.5</td>
      </tr>
  </tbody>
</table>
<h3 id="82-gpu-与显存问题">8.2 GPU 与显存问题</h3>
<table>
  <thead>
      <tr>
          <th>问题现象</th>
          <th>解决方案</th>
          <th>操作命令 / 配置</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>nvidia-smi 命令找不到</td>
          <td>重新安装显卡驱动</td>
          <td>Ubuntu：sudo apt reinstall nvidia-driver-550-server; Windows：重新运行 NVIDIA 驱动安装程序</td>
      </tr>
      <tr>
          <td>CUDA 版本不匹配（nvcc 与 nvidia-smi 显示不同）</td>
          <td>配置环境变量指定 CUDA 11.8</td>
          <td>Ubuntu：echo &rsquo;export PATH=/usr/local/cuda-11.8/bin:$PATH&rsquo; &raquo; ~/.bashrc; source ~/.bashrc</td>
      </tr>
      <tr>
          <td>训练中途 OOM（显存不足）</td>
          <td>启用 4-bit 量化 + 梯度检查点 + 优化器分页</td>
          <td>模型加载时设置 load_in_4bit=True、use_gradient_checkpointing=&ldquo;unsloth&rdquo;、optim=&ldquo;paged_adamw_8bit&rdquo;</td>
      </tr>
      <tr>
          <td>batch size 无法增大</td>
          <td>增加梯度累积步数</td>
          <td>training_args.gradient_accumulation_steps=16（等效 batch size=1*16=16）</td>
      </tr>
  </tbody>
</table>
<h3 id="83-模型与数据问题">8.3 模型与数据问题</h3>
<table>
  <thead>
      <tr>
          <th>问题现象</th>
          <th>解决方案</th>
          <th>操作命令 / 配置</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>模型下载速度慢 / 超时</td>
          <td>使用国内镜像源</td>
          <td>pip config set global.index-url <a href="https://mirrors.aliyun.com/pypi/simple/;" target="_blank">https://mirrors.aliyun.com/pypi/simple/;</a>
 export HF_ENDPOINT=https://hf-mirror.com（Ubuntu/WSL）</td>
      </tr>
      <tr>
          <td>Llama 系列模型权限不足</td>
          <td>申请权限并登录 Hugging Face</td>
          <td>1. 访问https://ai.meta.com/resources/models-and-libraries/llama-downloads/申请；2. huggingface-cli login</td>
      </tr>
      <tr>
          <td>训练过拟合（训练损失低，验证损失高）</td>
          <td>增加数据量 + 调整正则化参数</td>
          <td>1. 使用 prepare_qa_generation 生成更多样本；2. 模型配置中设置 lora_dropout=0.1</td>
      </tr>
      <tr>
          <td>数据格式错误（训练报错）</td>
          <td>重新检查 JSON 格式并清洗</td>
          <td>使用 load_local_json_dataset 函数中的 clean_data 逻辑过滤错误样本</td>
      </tr>
  </tbody>
</table>
<h2 id="九总结与选型建议">九、总结与选型建议</h2>
<h3 id="91-核心结论">9.1 核心结论</h3>
<ol>
<li>
<p><strong>Unsloth 是单机单卡最优选择</strong>：在显存优化（降低 75%）、训练速度（提升 30 倍）和微调效果上，显著优于 PEFT、Axolotl 等工具，24GB 显存可支持 7B 模型全参数微调。</p>
</li>
<li>
<p><strong>技术选型原则</strong>：</p>
</li>
</ol>
<ul>
<li>
<ul>
<li>16GB 显存：优先 QLoRA 微调（Llama 3.2-1B/Phi-4-Mini）。</li>
</ul>
</li>
<li>
<ul>
<li>24GB 显存：推荐 Unsloth 全参数微调（Mistral-7B/Llama 3.2-1B）。</li>
</ul>
</li>
<li>
<ul>
<li>80GB + 显存：全参数微调（Llama 3.2-70B，需调整 batch size 与梯度累积）。</li>
</ul>
</li>
</ul>
<h3 id="92-扩展建议">9.2 扩展建议</h3>
<ol>
<li>
<p><strong>多模态微调</strong>：使用 Unsloth 分离训练策略，冻结视觉编码器，仅微调语言解码器（如 LLaVA 系列模型）。</p>
</li>
<li>
<p><strong>推理优化</strong>：导出 GGUF 格式适配 Ollama，推理速度提升 30%；或使用 TensorRT 加速（需额外配置）。</p>
</li>
<li>
<p><strong>持续迭代</strong>：关注 Unsloth 社区更新（如动态批处理、混合量化），定期同步工具版本以获取性能优化。</p>
</li>
</ol>



      </section>

      
      <div class="divider"></div>
      <div class="flex flex-col md:flex-row justify-between gap-4 py-4">
        
        <div></div>
        

        
        <a role="button" class="btn btn-outline h-12" href="/posts/2025/ai-%E7%A0%94%E5%8F%91%E5%85%A8%E6%A0%88%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/" title="AI 研发全栈技术架构设计实战指南">
          <div class="inline-flex flex-col items-end">
            <span class="text-base-content/60 text-xs font-normal">下一页</span>
            <span class="max-w-48 truncate">AI 研发全栈技术架构设计实战指南</span>
          </div>
          <ion-icon name="chevron-forward"></ion-icon>
        </a>
        
      </div>
      

      
       

    </article>
  </div>

  <div
    x-data="tocHighlighter()"
    @scroll.window="debouncedScroll"
    class="hidden lg:flex lg:flex-col lg:items-end lg:self-start"
  >
    
      <nav id="TableOfContents">
  <ul>
    <li><a href="#一微调核心技术与工具横向对比">一、微调核心技术与工具横向对比</a>
      <ul>
        <li><a href="#11-核心微调技术对比">1.1 核心微调技术对比</a></li>
        <li><a href="#12-主流微调工具性能评测">1.2 主流微调工具性能评测</a></li>
      </ul>
    </li>
    <li><a href="#二系统环境搭建ubuntu-2204windows-11-双系统适配">二、系统环境搭建（Ubuntu 22.04/Windows 11 双系统适配）</a>
      <ul>
        <li><a href="#21-ubuntu-2204-系统配置">2.1 Ubuntu 22.04 系统配置</a></li>
        <li><a href="#22-windows-11-系统配置">2.2 Windows 11 系统配置</a></li>
        <li><a href="#23-python-环境与依赖配置">2.3 Python 环境与依赖配置</a></li>
      </ul>
    </li>
    <li><a href="#三数据集本地化处理">三、数据集本地化处理</a>
      <ul>
        <li><a href="#31-数据集结构与格式">3.1 数据集结构与格式</a></li>
        <li><a href="#32-数据集加载与清洗代码">3.2 数据集加载与清洗代码</a></li>
        <li><a href="#33-企业知识库场景数据增强可选">3.3 企业知识库场景数据增强（可选）</a></li>
      </ul>
    </li>
    <li><a href="#四模型配置与预加载">四、模型配置与预加载</a>
      <ul>
        <li><a href="#41-模型缓存路径设置避免重复下载">4.1 模型缓存路径设置（避免重复下载）</a></li>
        <li><a href="#42-模型预加载提前下载权重节省训练时间">4.2 模型预加载（提前下载权重，节省训练时间）</a></li>
        <li><a href="#43-模型加载配置分场景适配显存">4.3 模型加载配置（分场景适配显存）</a></li>
      </ul>
    </li>
    <li><a href="#五微调实战流程">五、微调实战流程</a>
      <ul>
        <li><a href="#51-训练参数配置">5.1 训练参数配置</a></li>
        <li><a href="#52-启动训练">5.2 启动训练</a></li>
      </ul>
    </li>
    <li><a href="#六训练监控工具配置">六、训练监控工具配置</a>
      <ul>
        <li><a href="#61-tensorboard-配置">6.1 TensorBoard 配置</a></li>
        <li><a href="#62-wandb-配置">6.2 WandB 配置</a></li>
      </ul>
    </li>
    <li><a href="#七模型部署与测试">七、模型部署与测试</a>
      <ul>
        <li><a href="#71-本地推理测试">7.1 本地推理测试</a></li>
        <li><a href="#72-flask-api-服务部署支持-http-调用">7.2 Flask API 服务部署（支持 HTTP 调用）</a></li>
        <li><a href="#73-导出为-gguf-格式适配-ollama-部署">7.3 导出为 GGUF 格式（适配 Ollama 部署）</a></li>
      </ul>
    </li>
    <li><a href="#八常见问题排查与优化">八、常见问题排查与优化</a>
      <ul>
        <li><a href="#81-依赖安装问题">8.1 依赖安装问题</a></li>
        <li><a href="#82-gpu-与显存问题">8.2 GPU 与显存问题</a></li>
        <li><a href="#83-模型与数据问题">8.3 模型与数据问题</a></li>
      </ul>
    </li>
    <li><a href="#九总结与选型建议">九、总结与选型建议</a>
      <ul>
        <li><a href="#91-核心结论">9.1 核心结论</a></li>
        <li><a href="#92-扩展建议">9.2 扩展建议</a></li>
      </ul>
    </li>
  </ul>
</nav>
    
  </div>
</div>


            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>
    © 2023 - 2025  -  AiEDU | BLOG
  </p>
  

  
  <p>知识改变命运，AI改变知识</p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
        <div class="back">
          <div class="container">
            
            <div class="dream-grid dream-grid-about">
  
  
  
  <div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column">
    <article
      class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"
    >
      <div class="card-body">
        <div class="card-title">关于我</div>

        <div class="prose dark:prose-invert">
          <p>Hi，这里是 <strong>AiEDU</strong> 的博客。<strong>AiEDU</strong> 是我在互联网上经常使用的名字。</p>
<p>我是一个热衷于开源的研发工程师，在这里我会记录一些关于技术等知识。欢迎你通过评论或者邮件与我交流。</p>

        </div>
      </div>
    </article>
  </div>
  
  <div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column">
    <article
      class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"
    >
      <div class="card-body">
        <div class="card-title">知识共享（Creative Commons）</div>

        <div class="prose dark:prose-invert">
          <p>此网站的所有内容都遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.25rem; text-decoration: underline;">CC BY-NC-SA 4.0<img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a>。</p>
<p>All contents of this website are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.25rem; text-decoration: underline;">CC BY-NC-SA 4.0<img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:22px; margin-top: 0; margin-bottom: 0;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a>.</p>

        </div>
      </div>
    </article>
  </div>
  
  

  
  <div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column">
    <article
      class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"
    >
      <div class="card-body">
        <div class="card-title">社交链接</div>

        <ul class="menu menu-horizontal flex-wrap w-full px-0 [&_ion-icon]:text-lg">
  
  <li>
    <a href="mailto:aiedu985@gmail.com" title="Email">
      <ion-icon name="mail"></ion-icon>
    </a>
  </li>
  

  
  <li>
    <a href="https://github.com/88899" target="_blank" title="GitHub">
      <ion-icon name="logo-github"></ion-icon>
    </a>
  </li>
  
  <li>
    <a href="https://x.com/mykenwayne" target="_blank" title="X">
      <ion-icon name="logo-x"></ion-icon>
    </a>
  </li>
  
  <li>
    <a href="https://www.linkedin.com/in/mykenwayne" target="_blank" title="Linkedin">
      <ion-icon name="logo-linkedin"></ion-icon>
    </a>
  </li>
  
  <li>
    <a href="https://stackoverflow.com/users/5676489/mykenwayne" target="_blank" title="stack overflow">
      <ion-icon name="logo-stackoverflow"></ion-icon>
    </a>
  </li>
  
</ul>

      </div>
    </article>
  </div>
  

  
</div>

            

            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>
    © 2023 - 2025  -  AiEDU | BLOG
  </p>
  

  
  <p>知识改变命运，AI改变知识</p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
      </div>
    </div>

    <script>
  window.lightTheme = "emerald"
  window.darkTheme = "forest"
</script>


  <script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>

  
  
    
  
  <script src="/js/grid.min.js"></script>




  

<script src="/js/main.min.js"></script>

    


  <script
  src="https://cdn.jsdelivr.net/npm/luxon@1.26.0"
  integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0="
  crossorigin="anonymous"
></script>
<script>
  format()

  function format() {
    document.querySelectorAll('span[data-format="luxon"]').forEach(el => {
      const date = el.textContent

      el.textContent = luxon.DateTime.fromISO(date, { locale: "zh" }).toFormat("yyyy年MM月dd日")
    })
  }
</script>



<script>
    window.customSyntaxHighlighting = {
      light: "/css/syntax-light.min.css",
      dark: "/css/syntax-dark.min.css"
    }

    document.addEventListener('alpine:initialized', () => {
      var isDark = Alpine.store('darkMode').isDark()
      var customSyntaxHighlightingUrl = isDark ? window.customSyntaxHighlighting.dark : window.customSyntaxHighlighting.light

      document
        .querySelector('link[data-custom-syntax-highlighting]')
        .setAttribute('href', customSyntaxHighlightingUrl)
    })
  </script>




  

<script src="/js/toc.min.js"></script>


  
    <script type="module">
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script>
  






    

    

    

    
    
      

<script async src="https://www.googletagmanager.com/gtag/js?id=G-7QPNK9FQQL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-7QPNK9FQQL');
</script>

    
        
    
<div class="scroll-buttons">
  <button id="scrollToTop" aria-label="滚动到顶部">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 19V5M5 12l7-7 7 7"/>
    </svg>
  </button>
  <button id="scrollToBottom" aria-label="滚动到底部">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 5v14M5 12l7 7 7-7"/>
    </svg>
  </button>
</div>

<style>
.scroll-buttons {
  position: fixed;
  right: 1rem;
  bottom: 1rem;  
  display: flex;
  flex-direction: column;
  gap: 0.6rem;  
  z-index: 99;
}

.scroll-buttons button {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  border: none;
  background-color: #28a745;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  transform: translateY(10px);
  box-shadow: 0 3px 12px rgba(40, 167, 69, 0.4);
}

.scroll-buttons button:hover {
  background-color: #218838;
  transform: translateY(0) scale(1.05);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.5);
}

.scroll-buttons button.visible {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

 
@media (max-width: 768px) {
  .scroll-buttons {
    right: 1rem !important;
    bottom: 1rem !important;  
    gap: 0.5rem !important;
  }

  .scroll-buttons button {
    width: 2.2rem !important;
    height: 2.2rem !important;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const scrollToTopBtn = document.getElementById('scrollToTop');
  const scrollToBottomBtn = document.getElementById('scrollToBottom');

  const handleScroll = () => {
    scrollToTopBtn.classList.toggle('visible', window.pageYOffset > 200);
    const isNearBottom = (window.innerHeight + window.pageYOffset) >= document.body.offsetHeight - 100;
    scrollToBottomBtn.classList.toggle('visible', !isNearBottom);
  };

  const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
  const scrollToBottom = () => window.scrollTo({
    top: document.documentElement.scrollHeight || document.body.scrollHeight,
    behavior: 'smooth'
  });

  window.addEventListener('scroll', handleScroll);
  scrollToTopBtn.addEventListener('click', scrollToTop);
  scrollToBottomBtn.addEventListener('click', scrollToBottom);
  handleScroll();
});
</script>

    
    <script>
  window.difyChatbotConfig = {
    token: 'h2hkg50dPRmb7SaR',
    inputs: {},
    systemVariables: {},
    userVariables: {
      avatar_url: 'https://cdn.jsdelivr.net/gh/dgdghub/dg-pic@main/blog/20250829110345042.png',
      name: 'AiEDU',
    },
  }
</script>
<script src="https://udify.app/embed.min.js" id="h2hkg50dPRmb7SaR" defer></script>

<style>
   
  #dify-chatbot-bubble-button {
    background-color: #28a745 !important;
    position: fixed !important;
    bottom: 1rem !important;  
    right: 1rem !important;  
    z-index: 9999 !important;
    width: 2.5rem !important;  
    height: 2.5rem !important;  
    box-shadow: 0 3px 12px rgba(40, 167, 69, 0.4) !important;
    margin: 0 !important;
    padding: 0 !important;
  }

   
  #dify-chatbot-bubble-window {
    width: 24rem !important;
    height: 70vh !important;
    max-height: 600px !important;
    min-height: 400px !important;
    position: fixed !important;
    bottom: 1rem !important;  
    right: 1rem !important;
    top: auto !important;
    left: auto !important;
    z-index: 9998 !important;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2) !important;
    transform: none !important;
    margin: 0 !important;
    padding: 0 !important;
    background-color: rgba(255, 255, 255, 0.9) !important;
  }

   
  @media (max-width: 768px) {
    #dify-chatbot-bubble-window {
      width: calc(100vw - 2rem) !important;
      height: 65vh !important;
      bottom: 1rem !important;  
      right: 1rem !important;
      left: 1rem !important;
    }

    #dify-chatbot-bubble-button {
      width: 2.2rem !important;
      height: 2.2rem !important;
      bottom: 1rem !important;
      right: 1rem !important;
    }
  }

   
  @supports (padding: env(safe-area-inset-bottom)) {
    #dify-chatbot-bubble-button {
      bottom: calc(1rem + env(safe-area-inset-bottom)) !important;
    }

    #dify-chatbot-bubble-window {
      bottom: calc(6.1rem + env(safe-area-inset-bottom)) !important;
    }

    @media (max-width: 768px) {
      #dify-chatbot-bubble-button {
        bottom: calc(1rem + env(safe-area-inset-bottom)) !important;
      }

      #dify-chatbot-bubble-window {
        bottom: calc(4.3rem + env(safe-area-inset-bottom)) !important;
      }
    }
  }
</style>


    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js" integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin="anonymous"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js" integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin="anonymous"></script>
  </body>
</html>
